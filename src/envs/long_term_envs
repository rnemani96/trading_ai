import gymnasium as gym
from gymnasium import spaces
import numpy as np


class LongTermInvestEnv(gym.Env):
    """
    Long-term investment environment
    Action: allocation weight (0â€“1)
    Observation: technical + fundamentals (simplified)
    """

    def __init__(self, data):
        super().__init__()
        self.data = data.reset_index(drop=True)
        self.step_idx = 0

        # action: % capital to invest
        self.action_space = spaces.Box(low=0.0, high=1.0, shape=(1,), dtype=np.float32)

        # observation: [price, rsi, ema20, ema50]
        self.observation_space = spaces.Box(
            low=-np.inf, high=np.inf, shape=(4,), dtype=np.float32
        )

        self.cash = 1.0
        self.position = 0.0

    def reset(self):
        self.step_idx = 0
        self.cash = 1.0
        self.position = 0.0
        return self._get_obs()

    def step(self, action):
        allocation = float(action[0])

        price = self.data.loc[self.step_idx, "Close"]
        next_price = self.data.loc[self.step_idx + 1, "Close"]

        self.position = allocation
        reward = self.position * ((next_price - price) / price)

        self.step_idx += 1
        done = self.step_idx >= len(self.data) - 2

        return self._get_obs(), reward, done, {}

    def _get_obs(self):
        row = self.data.loc[self.step_idx]
        return np.array(
            [row.Close, row.rsi, row.ema20, row.ema50],
            dtype=np.float32
        )
